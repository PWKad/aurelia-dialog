var gulp = require('gulp');
var fse = require('fs-extra');
var fs = require('fs');
var shell = require('child-process-promise');
var del = require('del');
var vinylPaths = require('vinyl-paths');
var runSequence = require('run-sequence');

var dirs = gulp.pkg.directories;

/**
 * Removes the generated documentation directory
 */
gulp.task('docs-clean', function() {
  return gulp.src([dirs.doc_output])
  .pipe(vinylPaths(del));
});

/**
 * Generate documentation using bfdocs
 */
gulp.task('docs-build', function (done) {
  shell.exec("bfdocs "+dirs.doc+"/manifest.json "+dirs.doc_output).then(function(){
    //HACK: overwrite the css generated by bfdocs as it is broken at the moment: https://github.com/beautiful-docs/beautiful-docs/issues/46
    fse.copy(dirs.doc+"/css",dirs.doc_output+"/assets/css",done);
  });
});

/**
 * Clean the dist directory first then build the files.
 */
gulp.task('docs', function(done) {
  return runSequence(
    'docs-clean',
    'docs-build',
    done
  );
});
